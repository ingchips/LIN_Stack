# lin_stack

# 基本说明
* 该文档采用markdown语法编写，请用相关工具打开增强阅读体验；
* 该文档介绍了 __lin协议栈__ 测试例程，包含主节点master和从节点slave两节点的例程；
* 该例程以电机转速与温度控制作为载体进行演示；


# 功能介绍
  * 该例程演示了master和slave之间用 __无条件帧__ 进行通讯的过程；
  ## 前置条件说明：
    * 主节点为控制节点，从节点为被控制节点，且从节点挂载了电机和温度检测传感器，且从节点的电机转速可被主节点控制；
    * 电机转速与温度的关系：
      - 电机的转速越高，则单位时间所产生的热量越高，则越容易发生高温损坏；
      - 主节点给从节点发送增加电机转速的命令，可间接增加温度；
      - 主节点给从节点发送降低电机转速的命令，可间接降低温度；
      - 主节点给从节点发送停止电机转动的命令，可快速降温；
    * 主节点的SeatECU有两个调度表：
      - __NormalTable调度表__ ：使用该调度表时，主机会不断和从机进行通讯，可通过主节点 __按键3__ 切换到该调度表；
      - __go-to-sleep调度表__ ：使用该调度表时，主机会进入休眠状态，不会和从机发生通讯，可通过主节点 __按键2__ 切换到该调度表；
    * 主节点的SeatECU在 __NormalTable调度表__ 时的行为；
      - 主节点通过LIN帧 __Motor1state_cycle__ 从从节点Motor1获取当前电机的温度信号（ __Motor1Temp__ ）；
      - 主节点通过LIN帧 __Motor1Control__ 向从节点Motor1发送选择电机转速的信号（ __Motor1Selection__ ）；
      - 两种帧按照固定间隔交替发送，除非切换到 __go-to-sleep调度表__ 后停止；
    * 主节点有两种LIN帧：
      - __Motor1state_cycle__ 帧：可获取从节点Motor1电机的温度信号（ __Motor1Temp__ ）；
      - __Motor1Control__  帧：可向从节点Motor1发送选择电机转速的信号（ __Motor1Selection__ ）；
    * 主节点选择电机转速的信号（ __Motor1Selection__ ）包含三种控制命令：
      - __INCREASE MOTOR SPEED__ 命令 ： 可提高电机转速，间接提高温度；
      - __DECREASE MOTOR SPEED__ 命令 ： 可降低电机转速，间接降低温度；
      - __STOP__ 命令 : 可立即停止电机转动，快速给电机降温；
    * 有两个温度阈值：
      - __MOTOR1_MAX_TEMP__ 温度阈值 ： 即 __最大温度值__ ，当小于该温度值时，可提高转速；当大于该温度值时，应降低转速，避免温度继续升高；
      - __MOTOR1_OVER_TEMP__ 温度阈值 ： 即 __过载温度值__ ，当小于该温度值，且大于 __最大温度值__  时应降低转速降温；当大于该温度值时，应立即停止电机转动，避免烧毁电机；
    * 有三种颜色指示灯：
      - __GREEN_LED__ ：绿灯，说明电机温度正常；
      - __BLUE_LED__  ：蓝灯，说明电机温度已超过 __最大温度值__ ，但仍小于 __过载温度值__ ；
      - __RED_LED__   ：红灯，说明电机温度过载，超过 __过载温度值__ ；

  ## 控制过程简述：
    * 刚开机时，主节点获取到的温度值在 __MOTOR1_MAX_TEMP__ 之下，属于正常范围，主节点通过 __Motor1Selection__ 信号发送 __INCREASE MOTOR SPEED__ 命令提高电机转速， 此时主节点和从节点均亮绿灯； 
    * 随着转速升高，温度也升高，当主节点获取到的温度超过 __MOTOR1_MAX_TEMP__ 但仍小于 __MOTOR1_OVER_TEMP__ 时，主节点SeatECU将通过 __Motor1Selection__ 信号发送 __DECREASE MOTOR SPEED__ 命令，降低电机转速，此时主节点和从节点均亮蓝灯。
    * 随着转速又降低，温度也降低，当主节点获取到的温度值又在 __MOTOR1_MAX_TEMP__ 之下时，双方又会亮绿灯；
    * 所以，在无人员干预的情况下，主从节点会将从节点的电机温度控制在 __MOTOR1_MAX_TEMP__ 附近，RGB灯也会相应的在绿灯和蓝灯之间交替闪烁，算是达到相对稳定的状态；
    * 此时，我们可以在从节点端强制设定电机转速来进行干预，调节的规则如下：
      - 当用户按下 __从节点__ 上的 __按键2__ 时，温度信号(Motor1_temp)的值将立即增加60个单位，则温度会超过最大值（绿灯），甚至过载值（红灯）。
      - 当用户按下 __从节点__ 上的 __按键3__ 时，温度信号的值将被立即设置为30个单位（低于 __MOTOR1_MAX_TEMP__ 的值），此时亮绿灯；
    * 主节点根据获取到的温度，按照以上规律，会做出相应的行为；

  ## 汇总按键功能
    * 主节点master：
      -  __按键2__ -----> __go-to-sleep表__ 
      -  __按键3__ -----> __NormalTable调度表__ 
    * 从节点slave：
      -  __按键2__ -----> 温度信号(Motor1_temp)的值将增加60个单位；
      -  __按键3__ -----> 温度信号的值将被立即设置为30个单位；

  ## 汇总RGB灯和温度之间的关系
    *  __GREEN_LED__ <-----> __MOTOR1_MAX_TEMP__ <-----> __BLUE_LED__ <-----> __MOTOR1_OVER_TEMP__ <-----> __RED_LED__ 
